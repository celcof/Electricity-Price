---
title: "FLOW"
author: "Francesco Cabras"
date: "21 April 2020"
output:
  html_document:
    df_print: paged
---
```{r, echo=F}
library(ggpubr)
library(car)
library(eurostat)
library(HDCI)
library(caret)
library(scales)
library(glmnet)
```

Take data from library eurostat. Start from the dependent variable.

```{r}
X <- get_eurostat("ten00117", time_format = "num")
X <- X[grep("MSHH", X$indic_en), c(5:7)]
X <- X[!(X$geo %in% c("EU28", "NO", "TR", "EA", "EU27_2020", "AL", "BA", "GE", "IS", "LI", "MD", "ME", "MK", "RS", "UA", "XK")),]
names(X)[3] <- "PRI"
X$geo <- as.factor(as.character(X$geo))
```

Dependency from imports.

```{r}
I <- get_eurostat("nrg_ind_id", time_format = "num")
I <- I[grep("TOTAL", I$siec), ]
I <- I[,c(3:5)]
names(I)[3] <- "DEP"
X <- merge(X, I, by=c("time", "geo"), all.x=TRUE)
```

Consumption of electricity.

```{r}
I <- get_eurostat("sdg_07_20", time_format = "num")
I <- I[, -1]
names(I)[3] <- "CON"
X <- merge(X, I, by=c("time", "geo"), all.x=TRUE)
```

Real gdp per capita.

```{r}
I <- get_eurostat("sdg_08_10", time_format = "num")
I <- I[grep("CLV10_EUR_HAB", I$unit), ]
I <- I[, -c(1,2)]
names(I)[3] <- "GDP"
X <- merge(X, I, by=c("time", "geo"), all.x=TRUE)
```

Oil price per barrel in dollars.

```{r}
time <- c(2008:2019)
OIL <- c(99.67,61.95,79.48,94.88,94.05,97.98,93.17,48.72,43.58,50.84,64.90,57.05)
I <- data.frame(time, OIL)
X <- merge(X, I, by="time", all.x=TRUE)
```

Share of renewable energy consumed.

```{r}
I <- get_eurostat("sdg_07_40", time_format = "num")
I <- I[I$nrg_bal == "REN", ]
I <- I[, -c(1,2)]
names(I)[3] <- "REN"
X <- merge(X, I, by=c("time", "geo"), all.x=TRUE)
```

Nuclear energy production.

```{r}
search_eurostat("nuclear")$code
I <- get_eurostat("nrg_inf_nuc", time_format = "num")
I <- I[grep("PRD_NUCH", I$plant_tec), ]
I <- I[,c(3:5)]
names(I)[3] <- "NUC"
X <- merge(X, I, by=c("time", "geo"), all.x=TRUE)
```

Emissions intensity.

```{r}
I <- get_eurostat("sdg_13_20", time_format = "num")
I <- I[,-1]
names(I)[3] <- "EMI"
X <- merge(X, I, by=c("time", "geo"), all.x=TRUE)
```

share of largest electricity generator in the market.

```{r}
I <- get_eurostat("ten00119", time_format = "num")
I <- I[,c(4:6)]
names(I)[3] <- "MAR"
X <- merge(X, I, by=c("time", "geo"), all.x=TRUE)
rm(I, OIL, time)
```

Price index

```{r}
I <- get_eurostat("prc_hicp_aind", time_format = "num")
I <- I[grep("CP00", I$coicop), ]
I <- I[grep("INX_A_AVG", I$unit), c(3:5)]
names(I)[3] <- "CPI"
X <- merge(X, I, by=c("time", "geo"), all.x=TRUE)
```

substitute NA with zero for nuclear capacity

```{r}
for (row in 1:length(X$NUC)){
  if(X$time[row] %in% c(2009:2018) & is.na(X$NUC[row])){
    X$NUC[row] <- 0
  }
}
for (country in levels(X$geo)){
  X[X$time == 2008 & X$geo == country, "NUC"] <- X[X$time == 2009 & X$geo == country, "NUC"]
}
rm(row)
```

substitute NA for Market Concentration

of Bulgaria. we miss values until 2012: we just substitute with first value available (2013)

```{r}
X[X$geo == "BG" & X$time %in% c(2008:2012), "MAR"] <- X[X$geo == "BG" & X$time == 2013, "MAR"]
```

Of Germany. goes from 28.4 in 2010 to 32.0 in 2013. we expect linear behaviour

```{r}
in2011 <- 28.4 + (32 - 28.4) / 3
in2012 <- in2011 + (32 - 28.4) / 3
X[X$geo == "DE" & X$time == 2011, "MAR"] <- in2011
X[X$geo == "DE" & X$time == 2012, "MAR"] <- in2012
rm(in2011, in2012)
```

Of Greece. in 2011, average between previous and subsequent years.

```{r}
X[X$geo == "EL" & X$time == 2011, "MAR"] <- mean(c(X[X$geo == "EL" & X$time == 2010, "MAR"], X[X$geo == "EL" & X$time == 2012, "MAR"]))
```

Of Luxembourg. We miss values until 2009: we just substitute with first value available (2010)

```{r}
X[X$geo == "LU" & X$time %in% c(2008:2009), "MAR"] <- X[X$geo == "LU" & X$time == 2010, "MAR"]
```

Of Austria. We miss values until 2010: we just substitute with first value available (2011). Also miss values from 2014 on. substitute with ones from 2013

```{r}
X[X$geo == "AT" & X$time %in% c(2008:2010), "MAR"] <- X[X$geo == "AT" & X$time == 2011, "MAR"]
X[X$geo == "AT" & X$time %in% c(2014:2018), "MAR"] <- X[X$geo == "AT" & X$time == 2013, "MAR"]
```

Of Netherlands: average year values from Belgium, Luxembourg and Germany. Also take a look at https://www.sciencedirect.com/science/article/pii/S0301421518308061

```{r}
for (i in 1:nrow(X)) {
  year <- X$time[i]
  if (X$geo[i] == "NL" && X$time[i] != 2019){
    DEvalue <- X[X$geo == "DE" & X$time == year, "MAR"]
    BEvalue <- X[X$geo == "BE" & X$time == year, "MAR"]
    LUvalue <- X[X$geo == "LU" & X$time == year, "MAR"]
    DKvalue <- X[X$geo == "DK" & X$time == year, "MAR"]
    NLvalue <- mean(c(DEvalue, BEvalue, LUvalue, DKvalue), na.rm=T)
    X[X$geo == "NL" & X$time == year, "MAR"] <- NLvalue
  }
  X$MAR <- round(X$MAR,1)
}
rm(DEvalue, BEvalue, LUvalue, DKvalue, NLvalue, i, year)
```

Of UK we miss values from 2014 on. substitute with ones from 2013.

```{r}
X[X$geo == "UK" & X$time %in% c(2014:2018), "MAR"] <- X[X$geo == "UK" & X$time == 2013, "MAR"]
```

Finally, sub na for EMI 2018 following the trend from 2016 and 2017 (value 2017 + (value 2017 - value 2016)).

```{r}
for (country in levels(X$geo)){
  X[X$time == 2018 & X$geo == country, "EMI"] <- X[X$time == 2017 & X$geo == country, "EMI"] + (X[X$time == 2017 & X$geo == country, "EMI"] - X[X$time == 2016 & X$geo == country, "EMI"])
}
rm(country)
```

Did not notice we also miss gdp poland for 2018. We assume that this value is following the trend of the last two years. value 2018 + diff(2017-2018)

```{r}
X[X$geo == "PL" & X$time == 2018, "GDP"] <- X[X$geo == "PL" & X$time == 2017, "GDP"] + (X[X$geo == "PL" & X$time == 2017, "GDP"] - X[X$geo == "PL" & X$time == 2016, "GDP"])
```

Missing too many values for 2019.

```{r}
X <- X[!X$time == 2019,]
X$CRI <- ifelse(X$time == 2011 | X$time == 2012, 1, 0)
```

Time to go dynamic.

```{r}
C <- X[X$time != 2008,]
for (col in c("PRI", "DEP", "CON", "GDP", "OIL", "REN", "NUC", "EMI", "MAR")){
    for (row in 1:nrow(C)){
        COU <- C[row, "geo"]
        YEA <- C[row, "time"]
        BEF <- YEA - 1
        C[row, col] <- X[X$time == YEA & X$geo == COU, col] - X[X$time == BEF & X$geo == COU, col]
    }
}
```

Simple Linear Model.

```{r}
LM1 <- lm(sqrt(PRI) ~ DEP + CON + GDP + OIL + REN + NUC + EMI + MAR + CRI + CPI, C)
summary(LM1)
```

Possible problems with assumptions. 

```{r}
plot(LM2)
```

Experiments.

```{r}
ggdensity(C$PRI, main = "Density function PRI")
qqnorm(C$PRI)
qqline(C$PRI)
```

```{r}
ggdensity(sqrt(C$PRI), main = "Density function PRI")
qqnorm(sqrt(C$PRI))
qqline(sqrt(C$PRI))
```

Also, normality of errors is not met.

```{r}
lawstat::runs.test(LM2$residuals)
```

Especially for the former, situation does not appear that dramatic. Situation does not look that bad, if we look at the plots for normality of errors and linearity assumption.

```{r}
plot(LM2, 1)
ggdensity(LM2$residuals, main = "Density function Residuals")
```

To be checked:
- residuals sum to zero
- no autocorrelation for residuals
- no perfect multicollinearity

```{r}
mean(LM2$residuals)
lawstat::runs.test(LM2$residuals)
vif(LM1)
```

The mean of the residuals is ok, however we have some problems for autocorrelation of residuals and multicollinearity. The Variance Inflator Formula results in not promising values for GDP and NUC. We should not worry too much about this, however: if we remove the country-specific dummy variables, the vif values for the model turn out to be normal. The multicollinearity risk is also refuted when looking at the correlation matrix for the continuous variables: the NUC feature is not strongly correlated with any of the other variables.

```{r}
library(corrplot)
corrplot(cor(C[, 3:11]))
```

Correlation of GDP with Price and Quantity Consumed is understandable but why does NUC have such a high VIF value? Not clear.

Overall check.

```{r}
gvlma::gvlma(LM2)
```