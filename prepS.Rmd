---
title: "prepS"
author: "Francesco Cabras"
date: "12 May 2020"
output: html_document
---

```{r, echo=F}
library(ggpubr)
library(car)
library(eurostat)
library(HDCI)
library(caret)
library(scales)
library(glmnet)
library(wbstats)
```

Take data from library eurostat. Start from the dependent variable.

```{r}
X <- get_eurostat("nrg_pc_204", time_format = "num")
X <- X[X$consom == "4161903" & X$tax == "X_TAX" & X$currency == "EUR", c(6:8)]
X <- X[!(X$geo == "EA" | X$geo == "EU27_2020" | X$geo == "EU28"),]
X$time <- as.character(as.character(X$time))
names(X)[3] <- "PRI"
X$time <- as.numeric(as.character(X$time))
X$geo <- as.factor(as.character(X$geo))
```

Price of natural gas.

```{r}
I <- get_eurostat("nrg_pc_202", time_format = "num")
I <- I[I$consom == "4141902" & I$tax == "X_TAX" & I$currency == "EUR" & I$unit== "GJ_GCV",c(6:8)]
names(I)[3] <- "GAS"
X <- merge(X, I, by=c("time", "geo"), all.x=TRUE)
```

Trying to get more data.

```{r}
I <- get_eurostat("nrg_pc_204_h", time_format = "num")
J <- get_eurostat("nrg_pc_202_h", time_format = "num")
I <- I[I$tax == "X_TAX" & I$currency == "EUR" & I$unit == "KWH" & I$consom == "4161150", c(6:8)]
J <- J[J$tax == "X_TAX" & J$currency == "EUR" & J$unit== "GJ_GCV" & J$consom == "4141150", c(6:8)]
names(I)[3] <- "PRI"
names(J)[3] <- "GAS"
I <- merge(I, J, by=c("time", "geo"), all.x=TRUE)
countries <- levels(X$geo)
I <- I[I$time < 2007 & I$geo %in% countries,]
X <- rbind(X, I)
X <- X[order(X$time),]
```

We take only data from 2000 on.

```{r}
X <- X[X$time >= 2000,]
```

Dependency from imports.

```{r}
I <- get_eurostat("nrg_ind_id", time_format = "num")
I <- I[grep("TOTAL", I$siec), ]
I <- I[,c(3:5)]
names(I)[3] <- "DEP"
X <- merge(X, I, by=c("time", "geo"), all.x=TRUE)
```

Consumption of electricity per capita.

```{r}
I <- get_eurostat("sdg_07_20", time_format = "num")
I <- I[, -1]
names(I)[3] <- "CON"
X <- merge(X, I, by=c("time", "geo"), all.x=TRUE)
```

Inflation indicator. It is monthly data so we have to subset it.

```{r}
I <- get_eurostat("ei_cphi_m", time_format = "num")
I <- I[I$indic == "CP-HI00" & I$unit == "HICP2015", ]
I <- I[, -c(1:3)]
names(I)[3] <- "INF"
X <- merge(X, I, by=c("time", "geo"), all.x=TRUE)
```

Emissions intensity.

```{r}
I <- get_eurostat("sdg_13_20", time_format = "num")
I <- I[,-1]
names(I)[3] <- "EMI"
X <- merge(X, I, by=c("time", "geo"), all.x=TRUE)
```

Share of largest electricity generator in the market.

```{r}
I <- get_eurostat("nrg_ind_331a", time_format = "num")
I <- I[,c(4:6)]
names(I)[3] <- "MAR"
X <- merge(X, I, by=c("time", "geo"), all.x=TRUE)
rm(I, J)
```

Share of energy from renewable sources, (in percentage) in consumption.

```{r}
I <- get_eurostat("nrg_ind_ren", time_format = "num")
I <- I[I$nrg_bal == "REN", ]
I <- I[, -c(1,2)]
names(I)[3] <- "REN"
U <- I
```

However, we are missing data from the time range 2000-2003. In this sense, we can make use of data from world bank to fill the gap. Both data sets should represent the same information, e.g. for data regarding 2004, they are almost equivalent: however, just pasting data belonging to two different data sets could be dangerous so we decide to normalize the world bank information multiplying each country value for 2000-2003 by a factor that makes eurostat and WB information match.

```{r}
J <- wb(indicator = "EG.FEC.RNEW.ZS", startdate = 2000, enddate = 2004, country=c(levels(X$geo), "GB", "GR"))
J$iso2c <- gsub("GB", "UK", J$iso2c)
J$iso2c <- gsub("GR", "EL", J$iso2c)
J <- J[,c(2,3,6)]
names(J) <- c("time", "WBren", "geo")
I <- merge(I, J, by=c("time", "geo"))
I$FAC <- I$REN / I$WBren
I <- I[,c(2,5)]
J <- merge(J, I, by="geo")
J$REN <- round(J$WBren * J$FAC, 3)
J <- J[J$time < 2004, c(1,2,5)]
U <- rbind(U, J)
X <- merge(X, U, by=c("time", "geo"), all.x=TRUE)
rm(U, J)
```

Real GDP per capita.

```{r}
I <- get_eurostat("namq_10_pc", time_format = "num")
I <- I[I$na_item == "B1GQ" & I$unit == "CP_EUR_HAB", ]
I <- I[, -c(1,2,3)]
names(I)[3] <- "GDP"
X <- merge(X, I, by=c("time", "geo"), all.x=TRUE)
```

Oil Price. Data taken from www.investing.com/commodities/brent-oil-historical-data.

```{r}
OIL <- c(58.58, 53.79, 68.76, 64.73, 50.17, 52.81, 41.6, 33.62, 47.12, 48.24, 98.17, 97.49, 105.03, 97.49, 88.06, 98.48, 95.7, 92.19, 78.95, 72.89, 69.45, 41.68, 124.08, 91.75, 78.21, 58.14, 74.4, 67.92, 60.57, 48.2, 43.8, 33.05, 30.54, 33.51, 27.02, 19.48, 26.35, 28.66, 27.43, 27.64)
time <- rev(levels(as.factor(X$time)))
OIL <- data.frame(OIL, time)
X <- merge(X, OIL, by=c("time"), all.x=TRUE)
rm(OIL, time, countries, I)
```

substitute NA for Market Concentration

of Bulgaria. we miss values until 2012: we just substitute with first value available (2013)

```{r}
X[X$geo == "BG" & X$time %in% c(2008:2012), "MAR"] <- X[X$geo == "BG" & X$time == 2013, "MAR"]
```

Of Germany. goes from 28.4 in 2010 to 32.0 in 2013. we expect linear behaviour

```{r}
in2011 <- 28.4 + (32 - 28.4) / 3
in2012 <- in2011 + (32 - 28.4) / 3
X[X$geo == "DE" & X$time == 2011, "MAR"] <- in2011
X[X$geo == "DE" & X$time == 2012, "MAR"] <- in2012
rm(in2011, in2012)
```

Of Greece. in 2011, average between previous and subsequent years.

```{r}
X[X$geo == "EL" & X$time == 2011, "MAR"] <- mean(c(X[X$geo == "EL" & X$time == 2010, "MAR"], X[X$geo == "EL" & X$time == 2012, "MAR"]))
```

Of Luxembourg. We miss values until 2009: we just substitute with first value available (2010)

```{r}
X[X$geo == "LU" & X$time %in% c(2008:2009), "MAR"] <- X[X$geo == "LU" & X$time == 2010, "MAR"]
```

Of Austria. We miss values until 2010: we just substitute with first value available (2011). Also miss values from 2014 on. substitute with ones from 2013

```{r}
X[X$geo == "AT" & X$time %in% c(2008:2010), "MAR"] <- X[X$geo == "AT" & X$time == 2011, "MAR"]
X[X$geo == "AT" & X$time %in% c(2014:2018), "MAR"] <- X[X$geo == "AT" & X$time == 2013, "MAR"]
```

Of Netherlands: average year values from Belgium, Luxembourg and Germany. Also take a look at https://www.sciencedirect.com/science/article/pii/S0301421518308061

```{r}
for (i in 1:nrow(X)) {
  year <- X$time[i]
  if (X$geo[i] == "NL" & year%%1==0){
    DEvalue <- X[X$geo == "DE" & X$time == year, "MAR"]
    BEvalue <- X[X$geo == "BE" & X$time == year, "MAR"]
    LUvalue <- X[X$geo == "LU" & X$time == year, "MAR"]
    DKvalue <- X[X$geo == "DK" & X$time == year, "MAR"]
    NLvalue <- mean(c(DEvalue, BEvalue, LUvalue, DKvalue), na.rm=T)
    X[X$geo == "NL" & X$time == year, "MAR"] <- NLvalue
  }
  X$MAR <- round(X$MAR,1)
}
rm(DEvalue, BEvalue, LUvalue, DKvalue, NLvalue, i, year)
```

Of UK we miss values from 2014 on. substitute with ones from 2013.

```{r}
X[X$geo == "UK" & X$time %in% c(2014:2018), "MAR"] <- X[X$geo == "UK" & X$time == 2013, "MAR"]
```

Finally, sub na for EMI 2018 and following the trend from 2016 and 2017 (value 2017 + t(value 2017 - value 2016)) with some inertia t (=1/3).

```{r}
X$geo <- as.factor(as.character(X$geo))
for (country in levels(X$geo)){
  if (country != "GE") {
  diff <- (X[X$time == 2017 & X$geo == country, "EMI"] - X[X$time == 2016 & X$geo == country, "EMI"])
  X[X$time == 2018 & X$geo == country, "EMI"] <- round(X[X$time == 2017 & X$geo == country, "EMI"] + diff / 3, 1)
  X[X$time == 2019 & X$geo == country, "EMI"] <- round(X[X$time == 2017 & X$geo == country, "EMI"] + 2 * diff / 3, 1) }
}
rm(country, diff)
```

Missing gas values. 25% of the value comes from the average of the country price and 75% from the average of the price from all countries for the year. This choice because empirically seen that, in general, prices increased over time.

```{r}
table(is.na(X$GAS), X$geo)

for (i in 1:nrow(X)) {
  year <- X$time[i]
  country <- X$geo[i]
  if (country %in% c("BE", "CZ", "DE", "EE", "EL", "LI", "LU", "MK", "PL", "PT") & is.na(X[i, "GAS"])) {
      X[i, "GAS"] <- weighted.mean(c(mean(X[X$geo==country,"GAS"],na.rm=T),mean(X[X$time==year,"GAS"],na.rm=T)),c(0.25,0.75))
  }
}
```



Not available gas price of cyprus. We use year average between greece and turkey for political and geographical reasons.
Not available gas price for kosovo, albania and montenegro. Substituted with year average between bosnia, greece, croatia, north macedonia, serbia.
Not available gas price for iceland, norway and finland. Substituted with year average between sweden, uk, denmark, estonia.
Finally, malta substituted with time average of italy and greece.

```{r}
for (i in 1:nrow(X)) {
  year <- X$time[i]
  if (X$geo[i] == "CY") {
    value1 <- X[X$geo == "TR" & X$time == year, "GAS"]
    value2 <- X[X$geo == "EL" & X$time == year, "GAS"]
    value <- mean(c(value1, value2), na.rm=T)
    X[i,"GAS"] <- value
  }
  else if (X$geo[i] == "XK" | X$geo[i] == "AL" | X$geo[i] == "ME") {
    value1 <- X[X$geo == "EL" & X$time == year, "GAS"]
    value2 <- X[X$geo == "HR" & X$time == year, "GAS"]
    value3 <- X[X$geo == "MK" & X$time == year, "GAS"]
    value4 <- X[X$geo == "RS" & X$time == year, "GAS"]
    value5 <- X[X$geo == "BA" & X$time == year, "GAS"]
    value <- mean(c(value1, value2, value3, value4, value5), na.rm=T)
    X[i,"GAS"] <- value
  }
  else if (X$geo[i] == "FI" | X$geo[i] == "IS" | X$geo[i] == "NO") {
    value1 <- X[X$geo == "UK" & X$time == year, "GAS"]
    value2 <- X[X$geo == "SE" & X$time == year, "GAS"]
    value3 <- X[X$geo == "DK" & X$time == year, "GAS"]
    value4 <- X[X$geo == "EE" & X$time == year, "GAS"]
    value <- mean(c(value1, value2, value3, value4), na.rm=T)
    X[i,"GAS"] <- value
  }
  else if (X$geo[i] == "MT") {
    value1 <- X[X$geo == "IT" & X$time == year, "GAS"]
    value2 <- X[X$geo == "EL" & X$time == year, "GAS"]
    value <- mean(c(value1, value2), na.rm=T)
    X[i,"GAS"] <- value
  }
}
X$MAR <- round(X$MAR,1)
rm(value2, value1, value, i, year, value3, value4, value5, country)
```

